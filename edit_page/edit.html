<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Edit Data Mahasiswa</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; min-height: 100vh; background: #fffaf3; }
    .sidebar h2 { margin: 0 0 30px; text-align: center; font-size: 20px; color: #fff; }
    .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; }
    .container { display: flex; width: 100%; background: #fff; border-radius: 20px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); overflow: hidden; margin: 0 auto; }
    .form-container { flex: 1; padding: 30px; background: #fffaf3; }
    h2 { color: #e76f51; margin-top: 0; font-size: 22px; }
    .section { margin-bottom: 20px; padding: 15px; border-left: 4px solid #f4a261; background: #fff7ee; border-radius: 8px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #f4a261; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .entry { position: relative; padding: 10px; margin-bottom: 10px; background: white; border: 1px solid #ccc; border-radius: 8px; }
    .remove-btn { position: absolute; top: 5px; right: 5px; background: #e63946; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
    .page { display: none; }
    .page.active { display: block; }
    .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Dashboard</h2>
    <div class="nav-links">
      <div class="nav-link" onclick="goToPage('dashboard.html')">Home</div>
      <div class="nav-link" onclick="goToPage('edit.html')">Edit Data</div>
      <div class="nav-link" onclick="goToPage('schedule.html')">Jadwal</div>
      <div class="nav-link" onclick="goToPage('tasks.html')">Tugas</div>
      <div class="nav-link" onclick="goToPage('agenda.html')">Agenda</div>
      <div class="nav-link" onclick="logout()">Logout</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <div class="form-container">
        <h2>Edit Data Mahasiswa</h2>
        <form id="editForm" enctype="multipart/form-data">
          <!-- Page 1 -->
          <div class="page active">
            <div class="section">
              <label>Nama Lengkap</label>
              <input type="text" id="name" required>
              <label>NIM</label>
              <input type="text" id="nim" required readonly>
              <label>Jenis Kelamin</label>
              <select id="gender" required>
                <option value="">Pilih</option>
                <option value="Laki-Laki">Laki-Laki</option>
                <option value="Perempuan">Perempuan</option>
              </select>
              <input type="hidden" id="role" value="4B - Teknik Multimedia dan Jaringan">
              <label>Link Avatar</label>
              <input type="url" id="avatar" placeholder="https://example.com/avatar.jpg">
              <label>Pesan Sambutan</label>
              <input type="text" id="welcome_message" placeholder="Selamat Datang">
            </div>
            <div class="nav-buttons">
              <span></span>
              <button type="button" onclick="nextPage()">Lanjut</button>
            </div>
          </div>

          <!-- Page 2: Tugas -->
          <div class="page">
            <div class="section" id="task-section">
              <h3>Tugas</h3>
              <div id="task-list"></div>
              <button type="button" onclick="addTask()" id="add-task">+ Tambah Tugas</button>
            </div>
            <div class="nav-buttons">
              <button type="button" onclick="prevPage()">Sebelumnya</button>
              <button type="button" onclick="nextPage()">Lanjut</button>
            </div>
          </div>

<!-- Page 3: Agenda -->
<div class="page">
  <div class="section" id="agenda-section">
    <h3>Agenda</h3>
    <div id="agenda-list"></div>
    <button type="button" onclick="addAgenda()" id="add-agenda">+ Tambah Agenda</button>
  </div>
  <div class="nav-buttons">
    <button type="button" onclick="prevPage()">Sebelumnya</button>
    <button type="button" onclick="nextPage()">Lanjut</button>
  </div>
</div>

<!-- Page 4: Foto Upload -->
<div class="page">
  <div class="section">
    <h3>Upload Foto Wajah (Opsional)</h3>
    <p style="font-size:13px; color:#777;">Anda dapat mengunggah hingga 5 foto. Biarkan kosong jika tidak ingin mengganti.</p>

    <div class="photo-grid">
      <label class="photo-circle" id="circle1">
        <input type="file" id="photo1" accept="image/*" onchange="previewImage(event, 1)">
        <img id="preview1" src="">
        <button type="button" class="remove-btn-circle" onclick="removePhoto(1)">×</button>
      </label>
      <label class="photo-circle" id="circle2">
        <input type="file" id="photo2" accept="image/*" onchange="previewImage(event, 2)">
        <img id="preview2" src="">
        <button type="button" class="remove-btn-circle" onclick="removePhoto(2)">×</button>
      </label>
      <label class="photo-circle" id="circle3">
        <input type="file" id="photo3" accept="image/*" onchange="previewImage(event, 3)">
        <img id="preview3" src="">
        <button type="button" class="remove-btn-circle" onclick="removePhoto(3)">×</button>
      </label>
      <label class="photo-circle" id="circle4">
        <input type="file" id="photo4" accept="image/*" onchange="previewImage(event, 4)">
        <img id="preview4" src="">
        <button type="button" class="remove-btn-circle" onclick="removePhoto(4)">×</button>
      </label>
      <label class="photo-circle" id="circle5">
        <input type="file" id="photo5" accept="image/*" onchange="previewImage(event, 5)">
        <img id="preview5" src="">
        <button type="button" class="remove-btn-circle" onclick="removePhoto(5)">×</button>
      </label>
    </div>
  </div>

  <button type="submit">Update Data</button>
  <p id="status" style="font-weight: bold;"></p>
  <div class="nav-buttons">
    <button type="button" onclick="prevPage()">Sebelumnya</button>
    <span></span>
  </div>
</div>

        </form>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>

  <script>
    // Sidebar nav + multi-page form nav
    function goToPage(page) { window.location.href = page + "?nim=" + nim; }
    let currentPage = 0;
    const pages = document.querySelectorAll(".page");
    function showPage(index) { pages.forEach((p, i) => p.classList.toggle("active", i === index)); }
    function nextPage() { if (currentPage < pages.length - 1) { currentPage++; showPage(currentPage); } }
    function prevPage() { if (currentPage > 0) { currentPage--; showPage(currentPage); } }
    document.addEventListener("DOMContentLoaded", () => showPage(currentPage));
    function logout() { auth.signOut().then(() => window.location.href = "login.html"); }

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDhLoamtCoPvVdEmI9EyiSUEtAcqBoj90Q",
      authDomain: "smartmirrortest1-a430b.firebaseapp.com",
      projectId: "smartmirrortest1-a430b",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let nim = null;

    const agendas = [], tasks = [];

    // Auth
    auth.onAuthStateChanged(user => {
      if (user) {
        nim = user.email.split('@')[0];
        loadUserData();
      } else { window.location.href = "login.html"; }
    });

    async function loadUserData() {
      const userRef = db.collection("users").doc(nim);
      const userDoc = await userRef.get();
      if (!userDoc.exists) return alert("Data mahasiswa tidak ditemukan!");
      const data = userDoc.data();
      document.getElementById("name").value = data.name || "";
      document.getElementById("nim").value = data.nim || "";
      document.getElementById("gender").value = data.gender || "";
      document.getElementById("avatar").value = data.avatar || "";
      document.getElementById("welcome_message").value = data.welcome_message || "";
      await loadAgenda(userRef);
      await loadTasks(userRef);
    }

    async function loadAgenda(userRef) {
      const snapshot = await userRef.collection("agenda").get();
      const list = document.getElementById("agenda-list");
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const ag = doc.data();
        const entry = createAgendaEntry(ag.title, ag.date, ag.time, ag.category, ag.description);
        agendas.push(entry);
        list.appendChild(entry);
      });
      toggleAddButton('agenda');
    }

    async function loadTasks(userRef) {
      const snapshot = await userRef.collection("tasks").get();
      const list = document.getElementById("task-list");
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const t = doc.data();
        const entry = createTaskEntry(t.title, t.due_date, t.category, t.description);
        tasks.push(entry);
        list.appendChild(entry);
      });
      toggleAddButton('task');
    }

    function createAgendaEntry(title="", date="", time="", category="", description="") {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove(); agendas.splice(agendas.indexOf(this.parentElement),1); toggleAddButton('agenda')">x</button>
        <input placeholder="Judul" value="${title}" required>
        <input type="date" value="${date}" required>
        <input placeholder="Waktu" value="${time}" required>
        <input placeholder="Kategori" value="${category}" required>
        <textarea placeholder="Deskripsi" required>${description}</textarea>`;
      return div;
    }

    function createTaskEntry(title="", due_date="", category="", description="") {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove(); tasks.splice(tasks.indexOf(this.parentElement),1); toggleAddButton('task')">x</button>
        <input placeholder="Judul" value="${title}" required>
        <input type="date" value="${due_date}" required>
        <input placeholder="Kategori" value="${category}" required>
        <textarea placeholder="Deskripsi" required>${description}</textarea>`;
      return div;
    }

    function addAgenda() { if (agendas.length < 3) { const e=createAgendaEntry(); agendas.push(e); document.getElementById("agenda-list").appendChild(e); toggleAddButton('agenda'); } }
    function addTask() { if (tasks.length < 3) { const e=createTaskEntry(); tasks.push(e); document.getElementById("task-list").appendChild(e); toggleAddButton('task'); } }
    function toggleAddButton(type) {
      if (type === 'agenda') document.getElementById('add-agenda').disabled = agendas.length >= 3;
      if (type === 'task') document.getElementById('add-task').disabled = tasks.length >= 3;
    }

      // === Foto Upload Preview & Remove ===
  function previewImage(event, index) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        const circle = document.getElementById("circle" + index);
        const img = document.getElementById("preview" + index);
        img.src = e.target.result;
        img.style.display = "block";
        circle.classList.add("has-photo");
      }
      reader.readAsDataURL(file);
    }
  }

  function removePhoto(index) {
    const input = document.getElementById("photo" + index);
    const img = document.getElementById("preview" + index);
    const circle = document.getElementById("circle" + index);

    input.value = "";
    img.src = "";
    img.style.display = "none";
    circle.classList.remove("has-photo");
  }
    
    // === Photo Upload to Ngrok Backend ===
async function uploadPhoto(file, nim, index) {
  if (!file) return;
  const formData = new FormData();
  formData.append("photo", file);
  formData.append("face_id", nim);
  formData.append("index", index);

  const response = await fetch("https://0b647dd102c4.ngrok-free.app/upload", {
    method: "POST",
    body: formData
  });

  const resultText = await response.text();
  console.log("Upload response:", resultText);

  let result;
  try { result = JSON.parse(resultText); }
  catch { throw new Error("Response is not valid JSON: " + resultText); }

  if (!response.ok || !(result.success || result.message)) {
    throw new Error(result.error || "Upload gagal");
  }
}

    // Submit logic
    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const status = document.getElementById("status");
      try {
        const userRef = db.collection("users").doc(nim);
        const name = document.getElementById("name").value;
        const gender = document.getElementById("gender").value;
        const role = document.getElementById("role").value;
        const avatar = document.getElementById("avatar").value;
        const welcome_message = document.getElementById("welcome_message").value;

        await userRef.set({ name, nim, gender, role, avatar, welcome_message }, { merge: true });

        // Upload photos (optional)
for (let i = 1; i <= 5; i++) {
  const file = document.getElementById("photo" + i).files[0];
  if (file) {
    await uploadPhoto(file, nim, i);
  }
}

        // Agenda
        const agendaRef = userRef.collection("agenda");
        const agDocs = await agendaRef.get();
        agDocs.forEach(d => agendaRef.doc(d.id).delete());
        for (let i = 0; i < agendas.length; i++) {
          const inputs = agendas[i].querySelectorAll("input, textarea");
          await agendaRef.doc("event_" + (i + 1)).set({
            title: inputs[0].value, date: inputs[1].value,
            time: inputs[2].value, category: inputs[3].value, description: inputs[4].value
          });
        }

        // Tasks
        const taskRef = userRef.collection("tasks");
        const tDocs = await taskRef.get();
        tDocs.forEach(d => taskRef.doc(d.id).delete());
        for (let i = 0; i < tasks.length; i++) {
          const inputs = tasks[i].querySelectorAll("input, textarea");
          await taskRef.doc("task" + (i + 1)).set({
            title: inputs[0].value, due_date: inputs[1].value,
            category: inputs[2].value, description: inputs[3].value
          });
        }

        status.style.color = "green";
        status.innerText = "Data berhasil diperbarui!";
      } catch (err) {
        status.style.color = "red";
        status.innerText = "Gagal update: " + err.message;
        console.error(err);
      }
    });
  </script>
</body>
</html>
